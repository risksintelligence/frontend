"use client";

import MainLayout from "@/components/layout/MainLayout";
import PagePrimer from "@/components/ui/PagePrimer";
import SkeletonLoader from "@/components/ui/SkeletonLoader";
import StatusBadge from "@/components/ui/StatusBadge";
import MetricCard from "@/components/ui/MetricCard";
import { useSectorVulnerability } from "@/hooks/useSectorVulnerability";
import { useMLModels } from "@/hooks/useMLModels";
import { getRiskLevel, getRiskTextColor, getAccessibilityPattern } from "@/lib/risk-colors";
import { useState, useCallback } from "react";
import { Button } from "@/components/ui/button";
import { AlertTriangle } from "lucide-react";

const SECTOR_OPTIONS = [
  "technology",
  "manufacturing", 
  "energy",
  "finance",
  "healthcare", 
  "transportation",
  "agriculture",
  "telecommunications",
  "retail",
  "aerospace",
  "automotive",
  "chemicals"
];

export default function SectorVulnerabilityPage() {
  const [selectedSector, setSelectedSector] = useState<string>("technology");
  const { 
    data: vulnerabilityData, 
    loading: vulnerabilityLoading,
    error: vulnerabilityError,
    refreshData,
    isStale 
  } = useSectorVulnerability(selectedSector);
  
  const {
    statusData: mlStatus,
    predictCascade,
    predictRisk,
    predictionLoading,
    modelsAvailable
  } = useMLModels();

  const handleSectorChange = (sector: string) => {
    setSelectedSector(sector);
  };

  const handlePredictRisk = useCallback(async () => {
    if (!vulnerabilityData) return;
    
    try {
      const features = vulnerabilityData.vulnerability_metrics.reduce((acc, metric) => {
        acc[metric.metric_name] = metric.current_value;
        return acc;
      }, {} as Record<string, any>);

      await predictRisk(`sector_${selectedSector}`, "sector", features);
    } catch (error) {
      console.error("Risk prediction failed:", error);
    }
  }, [vulnerabilityData, selectedSector, predictRisk]);

  const riskLevel = vulnerabilityData ? getRiskLevel(vulnerabilityData.overall_score) : null;

  return (
    <MainLayout>
      <main className="space-y-6 px-6 py-6">
        <header>
          <p className="text-xs uppercase tracking-wide text-terminal-muted">
            Supply Chain Intelligence
          </p>
          <h1 className="text-2xl font-bold uppercase text-terminal-text">
            Sector Vulnerability Assessment
          </h1>
          <p className="text-sm text-terminal-muted">
            Deep-dive risk analysis by sector using ML-powered vulnerability detection.
          </p>
        </header>

        <PagePrimer
          kicker="Primer"
          title="Sector Risk Intelligence"
          description="AI-driven vulnerability assessment combining sector-specific metrics with supply chain cascade modeling."
          expandable={true}
          showDataFlow={true}
          items={[
            {
              title: "Data Sources",
              content: "S&P Global sector analytics, supply chain topology, geopolitical events.",
              tooltip: "Real-time sector metrics with 30-second refresh from market intelligence APIs",
              expandedContent: "S&P Global Market Intelligence sector data, WTO Statistics trade flows, Free Geopolitical Intelligence events, Free Maritime Intelligence port congestion, WTO trade statistics, internal supply chain network topology from graph analysis algorithms."
            },
            {
              title: "ML Models", 
              content: "RandomForest vulnerability classifier, cascade prediction, risk scoring.",
              tooltip: "Ensemble models trained on historical sector disruption patterns",
              expandedContent: "RandomForest classifier for vulnerability categorization, Gradient Boosting for cascade likelihood prediction, Neural network risk scorer with SHAP explainability, all models retrained weekly on rolling 5-year dataset with cross-validation."
            },
            {
              title: "Risk Metrics",
              content: "Vulnerability score, cascade probability, mitigation recommendations.",
              tooltip: "Bloomberg-grade risk scoring with institutional clarity",
              expandedContent: "0-100 vulnerability score using weighted sector metrics, cascade probability from graph centrality analysis, mitigation recommendations from pattern matching against historical events, confidence intervals from model uncertainty quantification."
            }
          ]}
          dataFlowNodes={[
            {
              id: "sp-global",
              label: "S&P Global Intel",
              type: "source",
              status: "active",
              latency: "< 60s",
              quality: 94,
              description: "Market intelligence and sector analytics",
              endpoint: "/api/v1/intel/sp-global"
            },
            {
              id: "vulnerability-analyzer", 
              label: "Vulnerability Engine",
              type: "model",
              status: modelsAvailable ? "active" : "warning",
              latency: "< 5s",
              quality: modelsAvailable ? 91 : 65,
              description: "ML-powered sector risk assessment"
            },
            {
              id: "cascade-predictor",
              label: "Cascade Predictor", 
              type: "model",
              status: modelsAvailable ? "active" : "warning",
              latency: "< 3s",
              quality: modelsAvailable ? 88 : 60,
              description: "Supply chain cascade likelihood"
            },
            {
              id: "sector-dashboard",
              label: "Sector UI",
              type: "output", 
              status: "active",
              latency: "< 500ms",
              quality: 96,
              description: "Interactive vulnerability dashboard"
            }
          ]}
          dataFlowConnections={[
            { from: "sp-global", to: "vulnerability-analyzer", type: "real-time", volume: "~50 metrics/min" },
            { from: "vulnerability-analyzer", to: "cascade-predictor", type: "on-demand" },
            { from: "vulnerability-analyzer", to: "sector-dashboard", type: "real-time" },
            { from: "cascade-predictor", to: "sector-dashboard", type: "on-demand" }
          ]}
        />

        {/* Sector Selection */}
        <section className="space-y-4">
          <div className="flex items-center justify-between">
            <h3 className="text-lg font-bold text-terminal-text">Sector Selection</h3>
            <div className="flex items-center gap-2">
              {isStale && (
                <StatusBadge variant="warning" size="sm">
                  Stale Data
                </StatusBadge>
              )}
              <span className="text-xs font-mono text-terminal-muted">
                Last updated: {vulnerabilityData?.last_updated ? new Date(vulnerabilityData.last_updated).toLocaleString() : "N/A"}
              </span>
            </div>
          </div>
          
          <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
            {SECTOR_OPTIONS.map((sector) => (
              <Button
                key={sector}
                variant={selectedSector === sector ? "default" : "outline"}
                size="sm"
                onClick={() => handleSectorChange(sector)}
                className="text-xs font-mono uppercase"
              >
                {sector}
              </Button>
            ))}
          </div>
        </section>

        {/* Vulnerability Overview */}
        {vulnerabilityLoading ? (
          <SkeletonLoader variant="card" />
        ) : vulnerabilityError ? (
          <div className="terminal-card p-6">
            <div className="text-center space-y-2">
              <StatusBadge variant="critical">Error</StatusBadge>
              <p className="text-sm text-terminal-muted">{vulnerabilityError}</p>
              <Button onClick={refreshData} size="sm" variant="outline">
                Retry
              </Button>
            </div>
          </div>
        ) : vulnerabilityData ? (
          <section className="space-y-4">
            {/* Fallback Data Warning */}
            {vulnerabilityData?.fallback_data && (
              <div className="bg-amber-900/30 border border-amber-600/50 rounded-lg p-4 mb-6">
                <div className="flex items-center gap-2 mb-2">
                  <AlertTriangle className="w-5 h-5 text-amber-400" />
                  <h3 className="text-amber-400 font-semibold text-sm">Displaying Synthetic Data</h3>
                </div>
                <p className="text-amber-200 text-sm">
                  External API services are currently unavailable. The vulnerability assessment shown is simulated for demonstration purposes.
                  {vulnerabilityData?.metadata?.fallback_reason && (
                    <span className="block text-xs text-amber-300 mt-1">
                      Reason: {vulnerabilityData.metadata.fallback_reason}
                    </span>
                  )}
                </p>
              </div>
            )}
            
            <div className="flex items-center justify-between">
              <div>
                <h3 className="text-lg font-bold text-terminal-text">
                  {vulnerabilityData.sector_name.toUpperCase()} VULNERABILITY ASSESSMENT
                </h3>
                <p className="text-sm text-terminal-muted">
                  Risk analysis for {vulnerabilityData.sector_name} sector supply chains
                </p>
              </div>
              <div className="flex items-center gap-2">
                <Button 
                  onClick={handlePredictRisk}
                  disabled={!modelsAvailable || predictionLoading}
                  size="sm"
                  variant="outline"
                  className="font-mono text-xs"
                >
                  {predictionLoading ? "Predicting..." : "ML Predict"}
                </Button>
                <Button 
                  onClick={refreshData} 
                  size="sm"
                  variant="outline"
                  className="font-mono text-xs"
                >
                  Refresh
                </Button>
              </div>
            </div>

            {/* Overall Score Card */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <MetricCard
                title="Overall Vulnerability Score"
                value={vulnerabilityData.overall_score}
                unit="/ 100"
                change={0} // Could be calculated from historical data
                status={riskLevel?.semanticColor || "green"}
                updatedAt={vulnerabilityData.last_updated}
                className="col-span-1 md:col-span-2"
              />
              
              <div className="terminal-card p-4 space-y-2">
                <p className="text-xs uppercase tracking-wide text-terminal-muted font-mono">Risk Level</p>
                <div className="flex items-center gap-2">
                  <span className="text-xs font-mono">
                    {getAccessibilityPattern(vulnerabilityData.overall_score)}
                  </span>
                  <StatusBadge 
                    variant={riskLevel?.urgency === "HIGH" ? "critical" : riskLevel?.urgency === "MEDIUM" ? "warning" : "good"}
                  >
                    {vulnerabilityData.risk_level.toUpperCase()}
                  </StatusBadge>
                </div>
                <p className="text-xs text-terminal-muted font-mono">
                  {riskLevel?.meaning || "Assessment pending"}
                </p>
              </div>

              <div className="terminal-card p-4 space-y-2">
                <p className="text-xs uppercase tracking-wide text-terminal-muted font-mono">Metrics</p>
                <p className="text-xl font-bold font-mono text-terminal-text">
                  {vulnerabilityData.vulnerability_metrics.length}
                </p>
                <p className="text-xs text-terminal-muted font-mono">
                  Vulnerability factors
                </p>
              </div>
            </div>

            {/* Vulnerability Metrics */}
            <div className="space-y-4">
              <h4 className="text-md font-bold text-terminal-text">Detailed Vulnerability Metrics</h4>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                {vulnerabilityData.vulnerability_metrics.map((metric, index) => (
                  <div key={index} className="terminal-card p-4 space-y-3">
                    <div className="flex items-center justify-between">
                      <h5 className="text-sm font-semibold text-terminal-text uppercase font-mono">
                        {metric.metric_name.replace(/_/g, ' ')}
                      </h5>
                      <StatusBadge 
                        variant={metric.risk_level === "high" ? "critical" : 
                                metric.risk_level === "medium" ? "warning" : "good"}
                        size="sm"
                      >
                        {metric.risk_level}
                      </StatusBadge>
                    </div>
                    <div className="space-y-2">
                      <div className="flex items-center justify-between">
                        <span className="text-xs uppercase tracking-wide text-terminal-muted font-mono">
                          Current Value
                        </span>
                        <span className={`text-sm font-mono font-bold ${getRiskTextColor(metric.current_value)}`}>
                          {metric.current_value.toFixed(2)}
                        </span>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-xs uppercase tracking-wide text-terminal-muted font-mono">
                          Threshold
                        </span>
                        <span className="text-sm font-mono text-terminal-muted">
                          {metric.threshold.toFixed(2)}
                        </span>
                      </div>
                      <div className="relative w-full bg-terminal-border/20 rounded-full h-2">
                        <div 
                          className={`absolute top-0 left-0 h-full rounded-full ${
                            metric.current_value > metric.threshold 
                              ? "bg-terminal-red" 
                              : metric.current_value > metric.threshold * 0.8 
                              ? "bg-terminal-orange" 
                              : "bg-terminal-green"
                          }`}
                          style={{ 
                            width: `${Math.min(100, (metric.current_value / (metric.threshold * 1.2)) * 100)}%` 
                          }}
                        />
                      </div>
                      <p className="text-xs text-terminal-muted font-mono">
                        {metric.impact_description}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Recommendations */}
            <div className="space-y-4">
              <h4 className="text-md font-bold text-terminal-text">Mitigation Recommendations</h4>
              <div className="terminal-card p-4">
                <ol className="space-y-2">
                  {vulnerabilityData.recommendations.map((recommendation, index) => (
                    <li key={index} className="flex items-start gap-2">
                      <span className="text-xs font-mono text-terminal-muted mt-1">
                        {index + 1}.
                      </span>
                      <span className="text-sm text-terminal-text">
                        {recommendation}
                      </span>
                    </li>
                  ))}
                </ol>
              </div>
            </div>

            {/* ML Model Status */}
            {mlStatus && (
              <div className="space-y-4">
                <h4 className="text-md font-bold text-terminal-text">ML Model Status</h4>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="terminal-card p-4 space-y-2">
                    <p className="text-xs uppercase tracking-wide text-terminal-muted font-mono">Model Availability</p>
                    <div className="space-y-1">
                      <div className="flex items-center justify-between">
                        <span className="text-xs font-mono">Cascade Prediction</span>
                        <StatusBadge 
                          variant={mlStatus.model_availability.cascade_prediction ? "good" : "critical"}
                          size="sm"
                        >
                          {mlStatus.model_availability.cascade_prediction ? "Active" : "Offline"}
                        </StatusBadge>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-xs font-mono">Risk Scoring</span>
                        <StatusBadge 
                          variant={mlStatus.model_availability.risk_scoring ? "good" : "critical"}
                          size="sm"
                        >
                          {mlStatus.model_availability.risk_scoring ? "Active" : "Offline"}
                        </StatusBadge>
                      </div>
                    </div>
                  </div>

                  <div className="terminal-card p-4 space-y-2">
                    <p className="text-xs uppercase tracking-wide text-terminal-muted font-mono">Total Models</p>
                    <p className="text-xl font-bold font-mono text-terminal-text">
                      {mlStatus.model_availability.total_models}
                    </p>
                    <p className="text-xs text-terminal-muted font-mono">
                      Active ML models
                    </p>
                  </div>

                  <div className="terminal-card p-4 space-y-2">
                    <p className="text-xs uppercase tracking-wide text-terminal-muted font-mono">Recommendations</p>
                    <div className="space-y-1">
                      {mlStatus.recommendations.slice(0, 3).map((rec, index) => (
                        <p key={index} className="text-xs text-terminal-muted font-mono truncate">
                          {rec}
                        </p>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}
          </section>
        ) : null}
      </main>
    </MainLayout>
  );
}
