import { useCallback, useEffect, useState } from 'react';
import { getSectorVulnerabilities } from '@/services/realTimeDataService';
import { rrio } from '@/lib/monitoring';

interface VulnerabilityMetric {
  metric_name: string;
  current_value: number;
  threshold: number;
  risk_level: string;
  impact_description: string;
}

interface SectorVulnerabilityData {
  sector_name: string;
  overall_score: number;
  risk_level: string;
  vulnerability_metrics: VulnerabilityMetric[];
  recommendations: string[];
  last_updated: string;
}

interface SectorVulnerabilityState {
  data: SectorVulnerabilityData | null;
  loading: boolean;
  error: string | null;
  lastUpdated: string | null;
}

export const useSectorVulnerability = (sector?: string) => {
  const [state, setState] = useState<SectorVulnerabilityState>({
    data: null,
    loading: false,
    error: null,
    lastUpdated: null,
  });

  const fetchSectorVulnerability = useCallback(async () => {
    setState(prev => ({ ...prev, loading: true, error: null }));
    
    try {
      const vulnerabilityData = await getSectorVulnerabilities(sector);
      
      if (vulnerabilityData?.vulnerability_assessment) {
        setState({
          data: vulnerabilityData.vulnerability_assessment,
          loading: false,
          error: null,
          lastUpdated: new Date().toISOString(),
        });
        
        rrio.trackDataFetch('SectorVulnerability', 'success', {
          sector,
          score: vulnerabilityData.vulnerability_assessment.overall_score
        });
      } else {
        throw new Error('Invalid vulnerability data structure');
      }
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Unknown error';
      setState(prev => ({ 
        ...prev, 
        loading: false, 
        error: errorMessage 
      }));
      
      rrio.trackDataFetch('SectorVulnerability', 'error', {
        sector,
        error: errorMessage
      });
    }
  }, [sector]);

  const refreshData = useCallback(() => {
    fetchSectorVulnerability();
  }, [fetchSectorVulnerability]);

  useEffect(() => {
    fetchSectorVulnerability();
  }, [fetchSectorVulnerability]);

  return {
    ...state,
    refreshData,
    isStale: state.lastUpdated && 
      (Date.now() - new Date(state.lastUpdated).getTime()) > 300000, // 5 minutes
  };
};

export default useSectorVulnerability;