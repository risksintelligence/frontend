"use client";

import StatusBadge from "@/components/ui/StatusBadge";
import { getAccessibilityPattern, getRiskTextColor } from "@/lib/risk-colors";
import { NetworkSnapshot } from "@/lib/types";
import MethodologyModal, { useMethodologyModal } from "@/components/ui/MethodologyModal";

interface VulnerabilityTableProps {
  networkData: NetworkSnapshot;
  timestamp?: string;
}

export default function VulnerabilityTable({ networkData, timestamp }: VulnerabilityTableProps) {
  const vulnerabilities = networkData.vulnerabilities || [];
  const { isOpen, openModal, closeModal, modalProps } = useMethodologyModal();

  return (
    <section className="terminal-card space-y-4">
      <div className="flex items-center justify-between">
        <div>
          <p className="text-xs uppercase tracking-wide text-terminal-muted">
            Network Analysis
          </p>
          <h3 className="text-sm font-semibold uppercase text-terminal-text">
            Vulnerability Highlight List
          </h3>
        </div>
        <StatusBadge variant="info">
          {vulnerabilities.length} DETECTED
        </StatusBadge>
      </div>

      <div className="space-y-2">
        {vulnerabilities.map((vulnerability, index) => {
          const riskColor = getRiskTextColor(vulnerability.risk);
          const accessibilityPattern = getAccessibilityPattern(vulnerability.risk);

          return (
            <div
              key={`${vulnerability.node}-${index}`}
              className="flex items-center justify-between rounded border border-terminal-border bg-terminal-bg px-3 py-2"
            >
              <div className="flex-1">
                <div className="flex items-center gap-2">
                  <span className={`text-sm font-mono ${riskColor}`}>
                    {accessibilityPattern}
                  </span>
                  <p className="text-sm font-semibold text-terminal-text font-mono">
                    {vulnerability.node}
                  </p>
                </div>
                <p className="text-xs text-terminal-muted font-mono mt-1">
                  {vulnerability.description}
                </p>
              </div>
              <div className="text-right">
                <p className={`text-lg font-bold font-mono ${riskColor}`}>
                  {vulnerability.risk.toFixed(1)}
                </p>
                <p className="text-xs text-terminal-muted font-mono">
                  Risk Score
                </p>
              </div>
            </div>
          );
        })}
        
        {vulnerabilities.length === 0 && (
          <p className="text-sm text-terminal-muted font-mono">
            No vulnerabilities detected in current topology.
          </p>
        )}
      </div>

      <div className="border-t border-terminal-border pt-2">
        <p className="text-xs text-terminal-muted font-mono">
          Data: Live Data · Updated {timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString()} UTC
        </p>
        <button
          className="text-xs text-terminal-green hover:text-terminal-text font-mono transition-colors"
          onClick={() =>
            openModal({
              title: "Vulnerability Drivers",
              subtitle: "Critical nodes and partner risk",
              sections: [
                {
                  title: "Top Vulnerabilities",
                  content:
                    vulnerabilities.length > 0
                      ? vulnerabilities.slice(0, 5).map((v, idx) => (
                          <div key={idx}>
                            {v.node}: {v.description} (risk {v.risk})
                          </div>
                        ))
                      : "No vulnerabilities reported.",
                  type: "outputs",
                },
                {
                  title: "Mitigation Guidance",
                  content: "Monitor critical nodes and reinforce partner dependencies; align with failover playbooks.",
                  type: "process",
                },
              ],
            })
          }
        >
          Explain Drivers →
        </button>
      </div>
      <MethodologyModal {...modalProps} isOpen={isOpen} onClose={closeModal} />
    </section>
  );
}
